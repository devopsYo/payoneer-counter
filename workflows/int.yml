parameters:
- name: tag
  displayName: Tag
  type: string
  default: 1.0.x

pool:
  name: Default

jobs:
- job: Init_Vars
  variables:
    tag: $[ coalesce(variables['parameters.tag'], variables['Build.SourceBranchName']) ]
  steps:
  - script: echo "##vso[task.setvariable variable=tag;isOutput=true]$(tag)"
    name: InitTag
    displayName: 'Init Tag'
- job: CI
  dependsOn: Init_Vars
  variables:
    tag: $[ dependencies.Init_Vars.outputs['InitTag.tag'] ]
  steps:
  - script: docker login -u $(DOCKERHUB_USER) -p $(DOCKERHUB_PWD)
    displayName: 'Login Dockerhub'
  - script: docker build -t $(DOCKERHUB_USER)/payoneer-counter:$(tag) .
    displayName: 'Build Docker Image'
  - script: docker image push $(DOCKERHUB_USER)/payoneer-counter:$(tag)
    displayName: 'Push Docker Image'
- job: CD
  dependsOn: Init_Vars, CI
  variables:
    tag: $[ dependencies.Init_Vars.outputs['InitTag.tag'] ]
  steps:
  - script: docker image pull $(DOCKERHUB_USER)/payoneer-counter:$(tag)
    displayName: 'Pull Docker Image'
